FROM --platform=$BUILDPLATFORM node:20-alpine AS ui-builder
WORKDIR /app/web

COPY control-plane/web/client/package*.json ./
RUN npm ci
COPY control-plane/web/client/ .
RUN npm run build

FROM --platform=$BUILDPLATFORM golang:1.24-bookworm AS go-builder
WORKDIR /app

ARG TARGETOS
ARG TARGETARCH
ENV CGO_ENABLED=1

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    pkg-config \
    gcc-aarch64-linux-gnu \
    libc6-dev-arm64-cross \
    gcc-x86-64-linux-gnu \
    libc6-dev-amd64-cross \
    && rm -rf /var/lib/apt/lists/*

COPY control-plane/go.mod control-plane/go.sum ./control-plane/
RUN cd control-plane && go mod download

COPY control-plane/ ./control-plane/
COPY --from=ui-builder /app/web/dist ./control-plane/web/client/dist

RUN cd control-plane && \
    if [ "${TARGETARCH}" = "arm64" ]; then export CC=aarch64-linux-gnu-gcc; \
    elif [ "${TARGETARCH}" = "amd64" ]; then export CC=x86_64-linux-gnu-gcc; fi && \
    GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -tags "embedded sqlite_fts5" -o /app/bin/playground-server ./cmd/playground-server

# Pre-create writable data directory for distroless runtime. The nonroot user
# has UID/GID 65532 in the base image, so match that here.
RUN mkdir -p /tmp/playground-data && chown 65532:65532 /tmp/playground-data

FROM gcr.io/distroless/base-debian12

LABEL org.opencontainers.image.source=https://github.com/hanzoai/playground
LABEL org.opencontainers.image.description="Hanzo Playground - Bot Control Plane"
LABEL org.opencontainers.image.licenses=MIT

COPY --from=go-builder /app/bin/playground-server /usr/local/bin/playground-server
COPY --from=go-builder /app/control-plane/config /etc/playground/config
COPY --from=go-builder --chown=nonroot:nonroot /tmp/playground-data /data
USER nonroot:nonroot
ENTRYPOINT ["/usr/local/bin/playground-server"]
